# ソースコードのロジック詳細

---

## **目的**
このコードは、Excelファイル内の複数のシートを読み込み、HCL（HashiCorp Configuration Language）形式の`.tfvars`ファイルを生成します。以下の階層構造を持つHCL形式を出力します：

- 最上位にブック名（Excelファイル名）
- 次にシート名
- 各シート内のリソース名
- リソースに関連するパラメータとその値

---

## **主な機能とロジック**

### **1. ブックの読み込み**
- **対象関数**: `read_excel_sheets`
- **目的**:
  - Excelファイル内のすべてのシートを辞書形式で読み込む。
  - 各シート名をキー、対応するデータフレームを値として保持。
- **ロジック**:
  1. `pd.read_excel`の`sheet_name=None`オプションを使用。
  2. これにより、すべてのシートが辞書形式で読み込まれる。

---

### **2. パラメータの処理**
- **対象関数**: `parse_nested_key`
- **目的**:
  - ドット区切りのキー（例: `root_block_device.0.volume_size`）を解析し、適切なネストされた構造（辞書またはリスト）を構築。
- **ロジック**:
  1. `argument`をドットで分割してキーのリストを作成。
  2. 再帰的に各キーを処理。
  3. 最後のキーに値を設定し、それ以外のキーではリストや辞書を動的に初期化。
  4. キーが数値の場合はリストとして処理し、適切なインデックスに要素を挿入。
  5. キーが文字列の場合は辞書として処理し、キーに対応する値を設定。

---

### **3. リソースの構築**
- **対象関数**: `convert_book_to_hcl`
- **目的**:
  - ブック全体を処理し、HCL形式の階層構造を構築。
- **ロジック**:
  1. **シートの処理**:
     - `read_excel_sheets`で読み込んだ各シートについて、データを行単位で処理。
     - `resource`ごとに辞書を作成。
     - `arguments`を解析し、再帰的にネストされた構造を構築。
  2. **シートの統合**:
     - 各シート名を最上位のキーとしてリソースを統合。
  3. **ブック名の統合**:
     - ブック名を最上位のキーとして、すべてのシートを統合。

---

### **4. HCL形式へのフォーマット**
- **対象関数**: `format_value_as_hcl`
- **目的**:
  - ネストされたリストや辞書をHCL形式の文字列に変換。
- **ロジック**:
  1. 値がリストの場合：
     - 要素がすべて辞書なら、HCL形式でリスト内の辞書を整形。
     - それ以外のリストはJSON形式で出力。
  2. 値が辞書の場合：
     - 再帰的に辞書の各キーと値を処理。
  3. 単純な値の場合：
     - `json.dumps`を利用して文字列化。

---

### **5. HCLファイルの生成**
- **対象関数**: `debug_main_with_book_and_sheets`
- **目的**:
  - HCL形式の文字列をファイルに出力。
- **ロジック**:
  1. `convert_book_to_hcl`でブック全体をHCL形式に変換。
  2. 出力フォルダが存在しない場合は作成。
  3. HCL形式の文字列を`output.tfvars`に書き込む。

---

## **HCL出力の階層構造**
以下のような階層構造のHCLファイルが生成されます。

```hcl
ec2 = {                       # ブック名（Excelファイル名）
  Sheet1 = {                  # シート名
    aws_instance = {          # リソース名
      ami = "ami-005e54dee72cc1d00"
      root_block_device = [   # リスト構造
        {
          volume_size = 20
          volume_type = "gp3"
        },
        {
          volume_size = 40
          volume_type = "gp4"
        }
      ]
      tags = {                # 辞書構造
        Name = "ec2"
        Environment = "dev"
      }
    }
  }
}
