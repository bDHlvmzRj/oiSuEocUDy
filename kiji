# Terraformãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å®‰å…¨ã«å…±æœ‰ã™ã‚‹æ–¹æ³•ï¼ˆEC2ã¨ALBã®ä¾‹ï¼‰

## ã€ã¯ã˜ã‚ã«ã€‘

Terraformã‚’ç”¨ã„ã¦AWSãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºå®Ÿã«æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã¨ãƒªã‚½ãƒ¼ã‚¹ã®åˆ†é›¢ãŒé‡è¦ã§ã™ã€‚

ãã®ä¸­ã§ã‚‚ã€ŒSecurity Group(SG)ã€ã¯è¤‡æ•°ãƒªã‚½ãƒ¼ã‚¹é–“ã§å…±æœ‰ã•ã‚Œã‚‹ã“ã¨ãŒå¤šãã€é©åˆ‡ãªå…±æœ‰æ–¹æ³•ã‚’ä½¿ã‚ãªã„ã¨ã€å®Ÿè¡Œæ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚„ã‚µã‚¤ã‚¯ãƒ«ä¾å­˜ã®åŸå› ã¨ãªã‚Šã¾ã™ã€‚

ã“ã®ãƒ–ãƒ­ã‚°ã§ã¯ã€EC2ã¨ALBã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã§SGã‚’å…±æœ‰ã™ã‚‹éš›ã®ã€å®‰å…¨ã§ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è§£èª¬ã—ã¾ã™ã€‚AWSã‚„Terraformã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å¼•ç”¨ã—ã¤ã¤ã€æ ¹æ‹ ã‚ã‚‹è¨­è¨ˆã‚’æç¤ºã—ã¾ã™ã€‚

---

## ã€å‰æã€‘

* EC2ã¯ALBã‹ã‚‰ã®ã¿é€šä¿¡ã‚’å—ã‘ä»˜ã‘ã‚‹
* ALBã¨EC2ã§åˆ¥ã®SGã‚’ä½¿ç”¨
* Terraformã§ã¯ãƒªã‚½ãƒ¼ã‚¹ã‚’moduleã«åˆ†é›¢

---

## ã€ãªãœSGå…±æœ‰ã¯é›£ã—ã„ã®ã‹ï¼Ÿã€‘

Terraformã§ã¯ã€`aws_security_group`ã®IDã‚’ä»–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™ã«ã¯`output`ã¨`variable`ã‚’ç”¨ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šæ˜ç¤ºçš„ãªä¾å­˜é–¢ä¿‚ãŒç”Ÿã¾ã‚Œã€å®‰å…¨ã«SGã‚’å…±æœ‰ã§ãã¾ã™ã€‚

> ğŸ”— å‚è€ƒï¼šTerraform å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆã‚¬ã‚¤ãƒ‰ï¼ˆ[Module Composition](https://developer.hashicorp.com/terraform/language/modules/develop/composition)ï¼‰

ã¾ãŸã€AWSã§ã¯SGåŒå£«ã‚’å‚ç…§ã—ã¦ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã§ãã¾ã™ãŒã€ãã®éš› `source_security_group_id` ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

> ğŸ”— å‚è€ƒï¼šAWS SGå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆ[Security group rules](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#SecurityGroupRules)ï¼‰

---

## ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã€‘

```
modules/
  â”œ security_groups/  # SGã‚’ä½œæˆ
  â”œ ec2/              # EC2ã‚’ä½œæˆ
  â”” alb/              # ALBã‚’ä½œæˆ
```

---

## ã€modules/security\_groups/main.tfã€‘

```hcl
resource "aws_security_group" "web" {
  name        = "sg-web"
  description = "Allow HTTP from ALB"
  vpc_id      = var.vpc_id
}

resource "aws_security_group_rule" "web_inbound" {
  type              = "ingress"
  from_port         = 80
  to_port           = 80
  protocol          = "tcp"
  security_group_id = aws_security_group.web.id
  source_security_group_id = var.alb_sg_id
}

output "sg_web_id" {
  value = aws_security_group.web.id
}
```

### â–¶ variables.tf

```hcl
variable "vpc_id" {}
variable "alb_sg_id" {}
```

---

## ã€modules/alb/main.tfã€‘

```hcl
resource "aws_security_group" "alb" {
  name        = "sg-alb"
  description = "Allow internet access"
  vpc_id      = var.vpc_id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

output "sg_alb_id" {
  value = aws_security_group.alb.id
}
```

### â–¶ variables.tf

```hcl
variable "vpc_id" {}
```

---

## ã€modules/ec2/main.tfã€‘

```hcl
resource "aws_instance" "example" {
  ami                    = var.ami
  instance_type          = var.instance_type
  subnet_id              = var.subnet_id
  vpc_security_group_ids = [var.sg_web_id]
}
```

### â–¶ variables.tf

```hcl
variable "ami" {}
variable "instance_type" {}
variable "subnet_id" {}
variable "sg_web_id" {}
```

---

## ã€è¦ªmodule (main.tf)ã€‘

```hcl
module "alb" {
  source = "./modules/alb"
  vpc_id = module.vpc.vpc_id
}

module "security_groups" {
  source     = "./modules/security_groups"
  vpc_id     = module.vpc.vpc_id
  alb_sg_id  = module.alb.sg_alb_id
}

module "ec2" {
  source        = "./modules/ec2"
  ami           = "ami-12345678"
  instance_type = "t3.micro"
  subnet_id     = module.vpc.public_subnet_id
  sg_web_id     = module.security_groups.sg_web_id
}
```

---

## ã€ã¾ã¨ã‚ã€‘

* **SGã®ç”Ÿæˆã¯ä¸€ç®‡æ‰€ã«ã¾ã¨ã‚ã‚‹**ã¨ã€æ¬¡ç¬¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä¾å­˜ã‚’æŒãŸãšã«åˆ©ç”¨ã§ãã¾ã™
* **SGã®IDã¯outputã§æŠ•ã’ã‚‹**ã®ãŒä¸€ç•ªå®‰å…¨ï¼ˆTerraformãŒä¾å­˜é–¢ä¿‚ã‚’è‡ªå‹•ç®¡ç†ï¼‰
* **SGãƒ«ãƒ¼ãƒ«ã¯åˆ¥ã®resource(aws\_security\_group\_rule)ã§ç®¡ç†**ã™ã‚‹ã“ã¨ã§ã‚ˆã‚Šè‡ªç”±åº¦ãŒé«˜ã„

Terraformã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã§ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã®åˆ†é›¢ã ã‘ã§ãªãã€ãã®ä¾å­˜é–¢ä¿‚ã‚’ã©ã†ç®¡ç†ã™ã‚‹ã‹ãŒéåº¦ãª`depends_on`ã‚’é¿ã‘ã‚‹ã‚­ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

> âœ… è£œè¶³ï¼šTerraformã®ä¾å­˜é–¢ä¿‚è§£æ±ºã¯ã€å¤‰æ•°ã‚„outputã®å—ã‘æ¸¡ã—ã«ã‚ˆã£ã¦è‡ªå‹•ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€æ˜ç¤ºçš„ãª`depends_on`ã‚’å¤šç”¨ã™ã‚‹å¿…è¦ã¯åŸºæœ¬çš„ã«ã‚ã‚Šã¾ã›ã‚“ã€‚

> ğŸ”— å‚è€ƒï¼šTerraform å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ [Resource Dependencies](https://developer.hashicorp.com/terraform/language/resources/behavior#explicit-dependencies)
